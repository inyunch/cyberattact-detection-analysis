"""
Malware Detection Analysis Module
ML Task: Binary Classification (Malware vs Benign)
"""
import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import numpy as np
from modules.theme import get_chart_theme

def show(df):
    """Display malware detection analysis and ML-ready visualizations"""

    st.title("ðŸ¦  Malware Detection Analysis")
    st.markdown("""
    <div style="padding: 16px; background: linear-gradient(135deg, rgba(255, 75, 75, 0.1) 0%, rgba(255, 165, 0, 0.1) 100%);
                border-left: 4px solid #FF4B4B; border-radius: 8px; margin-bottom: 24px;">
        <p style="margin: 0; color: #A0A7B8; font-size: 0.95rem;">
            <strong style="color: #FF4B4B;">ML Task:</strong> Binary Classification |
            <strong style="color: #FF4B4B;">Target:</strong> is_malware |
            <strong style="color: #FF4B4B;">Features:</strong> Behavioral + Static Analysis
        </p>
    </div>
    """, unsafe_allow_html=True)

    # Key Metrics
    col1, col2, col3, col4 = st.columns(4)

    total_samples = len(df)
    malware_count = df['is_malware'].sum()
    benign_count = total_samples - malware_count
    malware_rate = (malware_count / total_samples) * 100

    with col1:
        st.metric("Total Samples", f"{total_samples:,}")
    with col2:
        st.metric("Malware Detected", f"{malware_count:,}", delta=f"{malware_rate:.1f}%")
    with col3:
        st.metric("Benign Files", f"{benign_count:,}")
    with col4:
        avg_detection = df['av_detection_rate'].mean()
        st.metric("Avg AV Detection", f"{avg_detection:.1%}")

    st.markdown("---")

    # Tabs for different analyses
    tab1, tab2, tab3, tab4 = st.tabs([
        "ðŸ“Š Overview & Distribution",
        "ðŸ”¬ Feature Analysis",
        "ðŸ§¬ Behavioral Patterns",
        "ðŸ¤– ML Preparation"
    ])

    with tab1:
        st.subheader("Dataset Overview")

        col1, col2 = st.columns(2)

        with col1:
            # Class distribution
            class_dist = df['is_malware'].value_counts().reset_index()
            class_dist.columns = ['Class', 'Count']
            class_dist['Class'] = class_dist['Class'].map({1: 'Malware', 0: 'Benign'})

            fig_class = px.pie(
                class_dist,
                values='Count',
                names='Class',
                title='Class Distribution',
                color='Class',
                color_discrete_map={'Malware': '#FF4B4B', 'Benign': '#00D9FF'},
                hole=0.4
            )
            fig_class.update_layout(**get_chart_theme())
            st.plotly_chart(fig_class, use_container_width=True)

        with col2:
            # Malware type distribution
            malware_types = df[df['is_malware'] == 1]['malware_type'].value_counts().reset_index()
            malware_types.columns = ['Malware Type', 'Count']

            fig_types = px.bar(
                malware_types,
                x='Count',
                y='Malware Type',
                orientation='h',
                title='Malware Type Distribution',
                color='Count',
                color_continuous_scale='Reds'
            )
            fig_types.update_layout(**get_chart_theme())
            st.plotly_chart(fig_types, use_container_width=True)

        # File type analysis
        st.subheader("File Type Analysis")

        file_type_malware = df.groupby(['file_type', 'is_malware']).size().reset_index(name='count')
        file_type_malware['Class'] = file_type_malware['is_malware'].map({1: 'Malware', 0: 'Benign'})

        fig_file = px.bar(
            file_type_malware,
            x='file_type',
            y='count',
            color='Class',
            title='File Type Distribution by Class',
            barmode='group',
            color_discrete_map={'Malware': '#FF4B4B', 'Benign': '#00D9FF'}
        )
        fig_file.update_layout(**get_chart_theme())
        st.plotly_chart(fig_file, use_container_width=True)

    with tab2:
        st.subheader("Feature Analysis")

        # Key numeric features
        numeric_features = ['entropy', 'file_size_kb', 'api_calls_count', 'network_connections',
                           'registry_changes', 'file_operations', 'imports_count', 'code_sections']

        # Feature distribution comparison
        feature_select = st.selectbox(
            "Select feature to analyze:",
            numeric_features,
            format_func=lambda x: x.replace('_', ' ').title()
        )

        col1, col2 = st.columns(2)

        with col1:
            # Violin plot
            df_plot = df.copy()
            df_plot['Class'] = df_plot['is_malware'].map({1: 'Malware', 0: 'Benign'})

            fig_violin = px.violin(
                df_plot,
                x='Class',
                y=feature_select,
                color='Class',
                title=f'{feature_select.replace("_", " ").title()} Distribution by Class',
                box=True,
                color_discrete_map={'Malware': '#FF4B4B', 'Benign': '#00D9FF'}
            )
            fig_violin.update_layout(**get_chart_theme())
            st.plotly_chart(fig_violin, use_container_width=True)

        with col2:
            # Box plot
            fig_box = px.box(
                df_plot,
                x='Class',
                y=feature_select,
                color='Class',
                title=f'{feature_select.replace("_", " ").title()} Boxplot',
                color_discrete_map={'Malware': '#FF4B4B', 'Benign': '#00D9FF'}
            )
            fig_box.update_layout(**get_chart_theme())
            st.plotly_chart(fig_box, use_container_width=True)

        # Feature correlation heatmap
        st.subheader("Feature Correlation Matrix")

        correlation_features = ['entropy', 'api_calls_count', 'network_connections',
                               'registry_changes', 'file_operations', 'suspicious_strings',
                               'av_detection_rate', 'is_malware']

        corr_matrix = df[correlation_features].corr()

        fig_corr = px.imshow(
            corr_matrix,
            title='Feature Correlation Heatmap',
            color_continuous_scale='RdBu_r',
            zmin=-1,
            zmax=1,
            aspect='auto'
        )
        fig_corr.update_layout(**get_chart_theme())
        st.plotly_chart(fig_corr, use_container_width=True)

    with tab3:
        st.subheader("Behavioral Pattern Analysis")

        # Behavioral indicators
        behavioral_features = ['api_calls_count', 'network_connections', 'registry_changes', 'file_operations']

        # Calculate means by class
        malware_means = df[df['is_malware'] == 1][behavioral_features].mean()
        benign_means = df[df['is_malware'] == 0][behavioral_features].mean()

        # Radar chart comparison
        categories = [f.replace('_', ' ').replace(' count', '').title() for f in behavioral_features]

        fig_radar = go.Figure()

        fig_radar.add_trace(go.Scatterpolar(
            r=malware_means.values,
            theta=categories,
            fill='toself',
            name='Malware',
            line_color='#FF4B4B'
        ))

        fig_radar.add_trace(go.Scatterpolar(
            r=benign_means.values,
            theta=categories,
            fill='toself',
            name='Benign',
            line_color='#00D9FF'
        ))

        fig_radar.update_layout(
            **get_chart_theme(),
            polar=dict(radialaxis=dict(visible=True)),
            title='Behavioral Pattern Comparison'
        )
        st.plotly_chart(fig_radar, use_container_width=True)

        # Scatter plots for behavioral analysis
        col1, col2 = st.columns(2)

        with col1:
            df_plot = df.copy()
            df_plot['Class'] = df_plot['is_malware'].map({1: 'Malware', 0: 'Benign'})

            fig_scatter1 = px.scatter(
                df_plot,
                x='entropy',
                y='api_calls_count',
                color='Class',
                title='Entropy vs API Calls',
                opacity=0.6,
                color_discrete_map={'Malware': '#FF4B4B', 'Benign': '#00D9FF'}
            )
            fig_scatter1.update_layout(**get_chart_theme())
            st.plotly_chart(fig_scatter1, use_container_width=True)

        with col2:
            fig_scatter2 = px.scatter(
                df_plot,
                x='network_connections',
                y='registry_changes',
                color='Class',
                title='Network Activity vs Registry Changes',
                opacity=0.6,
                color_discrete_map={'Malware': '#FF4B4B', 'Benign': '#00D9FF'}
            )
            fig_scatter2.update_layout(**get_chart_theme())
            st.plotly_chart(fig_scatter2, use_container_width=True)

        # Boolean features analysis
        st.subheader("Suspicious Indicators")

        bool_features = ['is_packed', 'obfuscated_code', 'anti_debug_detected']

        bool_data = []
        for feature in bool_features:
            malware_pct = (df[df['is_malware'] == 1][feature].sum() / malware_count) * 100
            benign_pct = (df[df['is_malware'] == 0][feature].sum() / benign_count) * 100

            bool_data.append({'Feature': feature.replace('_', ' ').title(), 'Malware': malware_pct, 'Benign': benign_pct})

        bool_df = pd.DataFrame(bool_data)

        fig_bool = go.Figure()
        fig_bool.add_trace(go.Bar(name='Malware', x=bool_df['Feature'], y=bool_df['Malware'], marker_color='#FF4B4B'))
        fig_bool.add_trace(go.Bar(name='Benign', x=bool_df['Feature'], y=bool_df['Benign'], marker_color='#00D9FF'))

        fig_bool.update_layout(
            **get_chart_theme(),
            barmode='group',
            title='Suspicious Indicator Prevalence (%)',
            yaxis_title='Percentage'
        )
        st.plotly_chart(fig_bool, use_container_width=True)

    with tab4:
        st.subheader("ðŸ¤– Machine Learning Preparation")

        st.markdown("""
        <div style="padding: 16px; background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, rgba(0, 255, 179, 0.1) 100%);
                    border-left: 4px solid #00D9FF; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="margin-top: 0; color: #00D9FF;">Dataset Ready for ML Training</h4>
            <p style="margin-bottom: 0; color: #A0A7B8;">
                This dataset is prepared for binary classification with clear features and target variable.
            </p>
        </div>
        """, unsafe_allow_html=True)

        # Dataset statistics
        col1, col2, col3 = st.columns(3)

        with col1:
            st.metric("Total Features", len(df.columns) - 3)  # Exclude sample_id, file_name, is_malware
            st.caption("Available for training")

        with col2:
            st.metric("Target Variable", "is_malware")
            st.caption("Binary: 0 (Benign) / 1 (Malware)")

        with col3:
            class_ratio = malware_count / benign_count
            st.metric("Class Ratio", f"{class_ratio:.2f}:1")
            st.caption("Malware:Benign")

        # Feature types breakdown
        st.markdown("#### Feature Types")

        feature_types = {
            'Numeric Features': ['file_size_kb', 'entropy', 'code_sections', 'imports_count',
                                'api_calls_count', 'network_connections', 'registry_changes',
                                'file_operations', 'suspicious_strings', 'av_detection_rate'],
            'Boolean Features': ['is_packed', 'obfuscated_code', 'anti_debug_detected'],
            'Categorical Features': ['file_type', 'malware_type']
        }

        for feat_type, features in feature_types.items():
            with st.expander(f"{feat_type} ({len(features)} features)"):
                st.write(", ".join(features))

        # ML Pipeline recommendation
        st.markdown("#### Recommended ML Pipeline")

        pipeline_code = """
# Example ML Pipeline for Malware Detection

import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler, LabelEncoder
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import classification_report, roc_auc_score, confusion_matrix

# Load data
df = pd.read_csv('data/malware_detection_dataset.csv')

# Prepare features
features = ['file_size_kb', 'entropy', 'code_sections', 'imports_count',
            'api_calls_count', 'network_connections', 'registry_changes',
            'file_operations', 'suspicious_strings', 'is_packed',
            'obfuscated_code', 'anti_debug_detected', 'av_detection_rate']

X = df[features]
y = df['is_malware']

# Handle categorical if needed (file_type encoding)
# X = pd.get_dummies(X, columns=['categorical_col'], drop_first=True)

# Split data (stratified for imbalanced classes)
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42, stratify=y
)

# Scale numeric features
scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)

# Train classifier
clf = RandomForestClassifier(
    n_estimators=100,
    max_depth=10,
    random_state=42,
    class_weight='balanced'  # Handle class imbalance
)
clf.fit(X_train_scaled, y_train)

# Evaluate
y_pred = clf.predict(X_test_scaled)
y_pred_proba = clf.predict_proba(X_test_scaled)[:, 1]

print(classification_report(y_test, y_pred))
print(f"ROC-AUC Score: {roc_auc_score(y_test, y_pred_proba):.4f}")

# Feature importance
feature_importance = pd.DataFrame({
    'feature': features,
    'importance': clf.feature_importances_
}).sort_values('importance', ascending=False)
print(feature_importance)
"""

        st.code(pipeline_code, language='python')

        # Download prepared data
        st.markdown("#### Download Dataset")

        csv = df.to_csv(index=False)
        st.download_button(
            label="ðŸ“¥ Download Malware Detection Dataset (CSV)",
            data=csv,
            file_name="malware_detection_ml_ready.csv",
            mime="text/csv"
        )

        # Class imbalance handling tips
        with st.expander("ðŸ’¡ Tips for Handling Class Imbalance"):
            st.markdown("""
            Since the dataset has a class imbalance (60% malware, 40% benign), consider:

            1. **Use stratified sampling** in train-test split
            2. **Class weights** in model training (`class_weight='balanced'`)
            3. **SMOTE** (Synthetic Minority Over-sampling Technique)
            4. **Evaluation metrics**: Focus on Precision, Recall, F1-Score, and ROC-AUC instead of just accuracy
            5. **Threshold tuning**: Adjust classification threshold based on business requirements

            ```python
            from imblearn.over_sampling import SMOTE

            smote = SMOTE(random_state=42)
            X_train_resampled, y_train_resampled = smote.fit_resample(X_train, y_train)
            ```
            """)
